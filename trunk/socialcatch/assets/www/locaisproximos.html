<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Locais próximos</title>

<link rel="stylesheet" type="text/css"
	href="lib/resources/css/sencha-touch.css" />
<script type="text/javascript" src="lib/sencha-touch.js"></script>
<script type="text/javascript" charset="utf-8" src="phonegap.js"></script>


</head>

<body>

	<script type="text/javascript">
		var latitude, longitude, nomelist, placeid, placetipo, placenome, placedesc;
		//Localização!!

		function updatePlacesProcura() {
			Ext.util.JSONP.request({
				url : 'http://dl.dropbox.com/u/1301044/JSON/test.json',
				callbackkey : 'callback',
				callback : function(data) {
					var nomelist = data.places;
					placesprocura.update(nomelist);

				}
			});
		}

		function updatePlacesProximos() {
			Ext.util.JSONP.request({
				url : 'http://dl.dropbox.com/u/1301044/JSON/test.json',
				callbackkey : 'callback',
				callback : function(data) {
					nomelist = data.places;
					placesproximos.update(nomelist);

				}
			});
		}

		// onSuccess Geolocation
		//

		function onSuccess(position) {

			alert('Latitude:' + position.coords.latitude + ' Longitude:'
					+ position.coords.longitude);
			latitude = position.coords.latitude;
			longitude = position.coords.longitude;
			updatePlacesProximos();

		}

		// onError Callback receives a PositionError object
		//
		function onError(error) {
			alert('code: ' + error.code + '\n' + 'message: ' + error.message
					+ '\n');
		}

		// process the confirmation dialog result
		function onConfirm(button) {
			//alert('Você selecionou:' + button);
			if (button == 1) {
				//window.location.href='mural.html?latitude=1.1111&longitude=2.222222';
				window.location.href = "mural.html?latitude=" + latitude
						+ "&longitude=" + longitude + "&placeid=" + placeid
						+ "&placetipo=" + placetipo + "&placenome=" + placenome
						+ "&placedesc=" + placedesc;
			}
		}

		function clickListItem(id) {
			var x;

			for (x = 0; x < nomelist.length; x++) {
				if (id == nomelist[x].id) {
					placeid = nomelist[x].id;
					placetipo = nomelist[x].tipo;
					placenome = nomelist[x].nome;
					placedesc = nomelist[x].descricao;

				}
			}

			navigator.notification.confirm('Deseja efetuar check-in?', // message
			onConfirm, // callback to invoke with index of button pressed
			'Check-in', // title
			'Sim,Não' // buttonLabels
			);

		}

		Ext
				.setup({

					onReady : function() {

						//Registar o callback para quando tiver a localização...
						navigator.geolocation.getCurrentPosition(onSuccess,
								onError);

						placesproximos = new Ext.Component(
								{
									title : "Places Próximos",
									scroll : 'vertical',
									tpl : [
											'<tpl for="."  >',
											'<div id={id} onClick="clickListItem(id)" style="margin-top:3px">',
											'<img alt="" height="45" src="{tipo}" width="45" style="margin-right:10px; float:left  "  ><h2 style="font-weight: bold"> {nome}</h2><h3> {descricao}</h3>',
											'<hr>', '</div>', '</tpl>' ]

								});

						placesprocura = new Ext.Component(
								{
									layout : 'fit',
									style : 'padding-bottom:10px;',
									tpl : [
											'<tpl for="."  >',
											'<div id={id} onClick="clickListItem(id)" style="margin-top:3px">',
											'<img alt="" height="45" src="{tipo}" width="45" style="margin-right:10px; float:left  "  ><h2 style="font-weight: bold"> {nome}</h2><h3> {descricao}</h3>',
											'<hr>', '</div>', '</tpl>' ]

								});

						searchPanel = new Ext.Panel({
							padding : 10,
							layout : {
								type : 'hbox',
								align : 'stretch'
							},
							items : [ {
								flex : 3,
								xtype : 'textfield',
								style : 'margin-right: 10px;',
								id : 'textquery'
							}, {
								flex : 2,
								xtype : 'button',
								text : 'Procurar',
								handler : function() {

									updatePlacesProcura();
									//var query = Ext.getCmp("textquery").getValue();
									//Ext.Ajax.request({
									//url: 'index.php?act=search&q='+query,
									//url : 'http://dl.dropbox.com/u/1301044/JSON/test.json',
									//success: function(e) {
									//var obj = Ext.util.JSON.decode(e.responseText);
									// var msg = obj.results;
									//    var html = tpl.apply(msg);
									//  alert(msg);
									//    placesproximos.update(msg);
									//   }
									//});
								}
							} ]
						});

						var placespornome = new Ext.Panel({
							title : "Procurar places",
							items : [ searchPanel, placesprocura ],
							scroll : 'vertical',
							//style: 'background: #DDEEF6;',
							fullscreen : true
						});

						var buttonsSpecBottom = [ {
							flex : 2,
							ui : 'back',
							text : 'Sair'
						}, {
							flex : 3,
							ui : 'action',
							text : 'Actualizar'
						} ]

						var tapHandler = function(btn, evt) {
							//alert("Button '" + btn.text + "' tapped.");
							if(btn.text=="Actualizar"){
								updatePlacesProcura();
								updatePlacesProximos();
							}else if(btn.text=="Sair"){
								window.location.href = "index.html";
							}
							
						}

						var dockedItems = [ {
							xtype : 'toolbar',
							ui : 'dark',
							dock : 'bottom',
							items : buttonsSpecBottom,
							defaults : {
								handler : tapHandler
							}
						} ]

						var panel = new Ext.TabPanel({
							fullscreen : true,
							animation : 'slide',
							items : [ placesproximos, placespornome ],
							dockedItems : dockedItems

						});

					}
				});
	</script>

</body>

</html>
